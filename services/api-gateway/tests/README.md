# API Gateway Tests

## Обзор

Данная директория содержит полный набор тестов для API Gateway сервиса. Тесты написаны с использованием pytest и обеспечивают 100% покрытие кода.

## Структура тестов

### test_admin_routes.py (8 тестов)
Тестирует административные маршруты:
- Создание, обновление, удаление зон
- Закрытие зон
- Получение списка зон администратором
- CORS preflight запросы (OPTIONS)

### test_auth.py (10 тестов)
Тестирует JWT аутентификацию:
- Валидация корректных токенов
- Обработка истёкших токенов
- Обработка невалидного формата токенов
- Обработка токенов с неправильным секретом
- Обработка отсутствующих заголовков Authorization
- Обработка неправильной схемы авторизации (не Bearer)
- Работа с user_id в поле 'sub'
- Дефолтное значение роли 'user'
- Административные токены

### test_booking_routes.py (6 тестов)
Тестирует маршруты бронирования:
- Получение мест в зоне
- Получение слотов
- Создание бронирования
- Создание бронирования по времени
- Отмена бронирования
- История бронирований

### test_error_handling.py (13 тестов)
Тестирует обработку ошибок:
- Проброс ошибок от backend сервисов (400, 404, 500)
- Ошибки регистрации и аутентификации
- Ошибки уведомлений
- Пустые результаты
- Проброс query параметров
- Проброс content-type
- Обработка больших ответов

### test_health.py (2 теста)
Тестирует health check и CORS:
- Проверка health check endpoint'а
- Проверка CORS заголовков

### test_notification_routes.py (8 тестов)
Тестирует маршруты уведомлений:
- Отправка уведомлений
- Массовая рассылка (только для админов)
- Получение уведомлений пользователя
- Проверка прав доступа
- CORS preflight запросы

### test_routes.py (4 теста)
Тестирует основные маршруты:
- Регистрация пользователя
- Вход пользователя
- Получение зон
- Продление бронирования с проверкой передачи тела запроса

### test_user_routes.py (3 теста)
Тестирует маршруты пользователей:
- Подтверждение email
- Восстановление пароля
- Сброс пароля

## Запуск тестов

### Запуск всех тестов
```bash
pytest tests/
```

### Запуск с подробным выводом
```bash
pytest tests/ -v
```

### Запуск с покрытием кода
```bash
pytest tests/ --cov=. --cov-report=term-missing
```

### Запуск конкретного файла тестов
```bash
pytest tests/test_auth.py -v
```

### Запуск конкретного теста
```bash
pytest tests/test_auth.py::test_expired_token_authentication -v
```

## Переменные окружения

Тесты используют следующие переменные окружения (с дефолтными значениями):
- `JWT_SECRET` - секретный ключ для JWT токенов (по умолчанию: "a-string-secret-at-least-256-bits-long")
- `USER_SERVICE_URL` - URL user сервиса (по умолчанию: "http://user-service:8001")
- `BOOKING_SERVICE_URL` - URL booking сервиса (по умолчанию: "http://booking-service:8002")
- `NOTIFICATION_SERVICE_URL` - URL notification сервиса (по умолчанию: "http://notification-service:8003")

## Фикстуры

### test_client (conftest.py)
Создаёт тестовый клиент FastAPI для всех тестов. Клиент автоматически очищается после каждого теста.

## Моки

Все тесты используют `unittest.mock` для мокирования HTTP запросов к backend сервисам:
- `routes.user.requests.*` - запросы к user service
- `routes.booking.requests.*` - запросы к booking service
- `routes.notification.requests.*` - запросы к notification service
- `routes.admin.requests.*` - запросы к admin endpoints

## Покрытие кода

Текущее покрытие: **100%**

```
auth.py                    100%
config.py                  100%
main.py                    100%
routes/admin.py            100%
routes/booking.py          100%
routes/notification.py     100%
routes/user.py             100%
```

## Best Practices

1. **Использование моков**: Все внешние зависимости мокируются для изоляции тестов
2. **Проверка прав доступа**: Тесты проверяют, что JWT токены корректно обрабатываются
3. **Проверка проброса данных**: Тесты проверяют, что тело запроса, заголовки и query параметры корректно пробрасываются
4. **Проверка ошибок**: Тесты проверяют, что ошибки от backend сервисов корректно возвращаются клиенту
5. **Edge cases**: Тесты покрывают граничные случаи (истёкшие токены, отсутствующие заголовки, пустые результаты)

## Добавление новых тестов

При добавлении нового endpoint'а:
1. Добавьте тест для успешного сценария
2. Добавьте тесты для ошибочных сценариев (401, 403, 404, 500)
3. Если endpoint требует аутентификацию, добавьте тесты без токена и с невалидным токеном
4. Проверьте, что все параметры корректно передаются в backend сервис
5. Запустите тесты с покрытием и убедитесь, что новый код покрыт на 100%
